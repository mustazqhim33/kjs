{% extends 'base.html' %}
{% block content %}

<div class="main-container">

    <!-- Rotated Horizontal Legend (bottom-to-top) -->
    <div class="legend-rotated" style="
        transform: rotate(180deg);
        writing-mode: vertical-rl;
        display: flex;
        gap: 20px;
        align-items: center;
        border: 1px solid #ccc;
        padding: 10px;
        border-radius: 6px;
        background: #f9f9f9;
    ">
        <div style="display: flex; align-items: center; gap: 6px;">
            <div style="width: 14px; height: 14px; background-color: #007bff; border-radius: 3px;"></div>
            <span style="font-size: 14px;">Active</span>
        </div>
        <div style="display: flex; align-items: center; gap: 6px;">
            <div style="width: 14px; height: 14px; background-color: #6c757d; border-radius: 3px;"></div>
            <span style="font-size: 14px;">Locked</span>
        </div>
        <div style="display: flex; align-items: center; gap: 6px;">
            <div style="width: 14px; height: 14px; background-color: #28a745; border-radius: 3px;"></div>
            <span style="font-size: 14px;">Completed</span>
        </div>
        <div style="display: flex; align-items: center; gap: 6px;">
            <div style="width: 14px; height: 14px; background-color: #ffc107; border-radius: 3px;"></div>
            <span style="font-size: 14px;">Pending</span>
        </div>
    </div>
    
    <!-- Flowchart Steps -->
    <div class="flowchart" style="margin-bottom: 20px;">
        {% set steps = [
            "Site Visit", "Compilation of Land Survey and Soil Investigation Report", "Consultant to Provide Preliminary Drawings", "Submission Regulatory Document", "Issue Letter of Intent & BQ Quotation", "Finalize Costing Matter", "Submission of Variation Order to Telco", "PBT Approval", "Verification of Contractor's Quotation/Work Instruction", "Submission of Work Schedule", "Preparation of Material", "Monitor Progress at Site", "Weeeky Progress Report", "Pre-Handover", "Notification of Handover", "Attend Handover", "Telco: Issuance of Defect List to KJS", "Issuance of Reminder-Defect List/Rectification", "Defect Clearance", "Submission of Defect Clearance Photo", "Issuance of CPC","Request Authorized Work Order", "Issuance of Authorized Work Order", "Invoices", "Drawdown", "Rental Payment", "Operation and Maintenance of Sites", "Claims from Contractors"
        ] %}
        {% for step in steps %}
        <button type="button" class="flowchart-box" data-step="{{ loop.index }}" disabled>{{ step }}</button>
        {% endfor %}
    </div>

    <!-- Form -->
    <div class="form">
        <form id="stepForm">
            <input type="hidden" id="step_number" name="step_number" />
            <div id="dynamicFields"></div>
            <button type="submit" class="submit-button" style="display: none;">Submit</button>
        </form>
    </div>
</div>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Script -->
<script>
let map, marker;
let currentStep = 1;

document.addEventListener("DOMContentLoaded", function () {
    const buttons = document.querySelectorAll(".flowchart-box");
    const dynamicFields = document.getElementById("dynamicFields");
    const submitButton = document.querySelector(".submit-button");
    const stepForm = document.getElementById("stepForm");

    // Initialize Step 1
    updateStepUI(1, 'blue', true);

    buttons.forEach(button => {
        button.addEventListener("click", () => {
            const step = parseInt(button.dataset.step);
            if (step > currentStep) return;

            buttons.forEach(btn => btn.classList.remove("active"));
            button.classList.add("active");
            document.getElementById("step_number").value = step;

            // Show form
            dynamicFields.innerHTML = getFormFields();
            submitButton.style.display = "inline-block";
            setTimeout(() => initMap(), 0);
            setupUserDropdown();
        });
    });

    stepForm.addEventListener("submit", function (e) {
        e.preventDefault();
        const status = document.getElementById("status").value;
        const step = parseInt(document.getElementById("step_number").value);

        if (status === "Proceed" && step === currentStep) {
            updateStepUI(step, 'green', true);
            currentStep++;
            if (currentStep <= buttons.length) {
                updateStepUI(currentStep, 'yellow', true);
            }
        }
        alert("Form submitted for Step " + step + " with status: " + status);
    });
});

function updateStepUI(step, color, enable) {
    const btn = document.querySelector(`.flowchart-box[data-step="${step}"]`);
    if (!btn) return;
    btn.disabled = !enable;
    btn.style.backgroundColor = (color === 'blue') ? '#007BFF' :
                                (color === 'green') ? '#28a745' :
                                (color === 'yellow') ? '#ffc107' :
                                '#6c757d';
    btn.style.color = 'white';
}

function getFormFields() {
    return `
        <!-- Row: Date + Project Name -->
        <div style="display: flex; gap: 20px;">
            <div style="flex: 1;">
                <label>Date</label>
                <input type="date" id="date" name="date" required>
            </div>
            <div style="flex: 1;">
                <label>Project Name</label>
                <input type="text" id="project_name" name="project_name" placeholder="Enter project name">
            </div>
        </div>

        <!-- Row: Client + PIC -->
        <div style="display: flex; gap: 20px; margin-top: 10px;">
            <div style="flex: 1;">
                <label>Client</label>
                <input type="text" id="client" name="client" required>
            </div>
            <div style="flex: 1;">
                <label>Person In Charge:</label>
                <div class="dropdown">
                    <input type="text" id="userSearch" placeholder="Search users..." autocomplete="off">
                    <input type="hidden" name="person_in_charge_id" id="selectedUserId">
                    <div id="userDropdown" class="dropdown-content">
                        {% for user in users %}
                            <div data-id="{{ user.users_id }}">{{ user.users_id }} - {{ user.users_name }}</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Row: Address, Locate, Lat/Lng -->
        <div style="margin-top: 10px;">
            <label for="address">Address</label>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="address" name="address" placeholder="Enter address" style="flex: 2;">
                <button type="button" class="locate-button" onclick="geocodeAddress()">Locate</button>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 5px;">
                <input type="text" id="latitude" name="latitude" placeholder="Latitude" style="flex: 1;" onblur="updateMapFromLatLng()">
                <input type="text" id="longitude" name="longitude" placeholder="Longitude" style="flex: 1;" onblur="updateMapFromLatLng()">
            </div>
        </div>

        <!-- Full Width Map -->
        <div style="margin-top: 15px;">
            <label>Location Map</label>
            <div id="map" style="height: 300px; width: 100%; border: 1px solid #ccc; border-radius: 8px;"></div>
        </div>

        <!-- Status Dropdown -->
        <div style="margin-top: 15px;">
            <label>Status</label>
            <select id="status" name="status" required>
                <option value="">-- Select Status --</option>
                <option value="Proceed">Proceed</option>
                <option value="Pending">Pending</option>
                <option value="In Progress">In Progress</option>
                <option value="Completed">Completed</option>
                <option value="On Hold">On Hold</option>
            </select>
        </div>

        <!-- Full Width File Upload -->
        <div style="margin-top: 15px;">
            <label>Upload File</label>
            <input type="file" id="file" name="file">
        </div>

        <!-- Full Width Comments -->
        <div style="margin-top: 15px;">
            <label>Comments</label>
            <textarea id="comments" name="comments" placeholder="Enter your comments..." style="width: 100%;"></textarea>
        </div>

        <!-- Other Field -->
        <div style="margin-top: 15px;">
            <label>Other</label>
            <input type="text" id="other" name="other" style="width: 100%;">
        </div>
    `;
}

function setupUserDropdown() {
    const searchInput = document.getElementById("userSearch");
    const dropdown = document.getElementById("userDropdown");
    const hiddenInput = document.getElementById("selectedUserId");

    searchInput.addEventListener("focus", () => {
        dropdown.style.display = "block";
    });

    searchInput.addEventListener("input", () => {
        const filter = searchInput.value.toLowerCase();
        const items = dropdown.getElementsByTagName("div");
        for (let item of items) {
            const text = item.textContent || item.innerText;
            item.style.display = text.toLowerCase().includes(filter) ? "" : "none";
        }
    });

    dropdown.addEventListener("click", (e) => {
        if (e.target && e.target.nodeName === "DIV") {
            const selectedText = e.target.textContent;
            const selectedId = e.target.getAttribute("data-id");
            searchInput.value = selectedText;
            hiddenInput.value = selectedId;
            dropdown.style.display = "none";
        }
    });

    document.addEventListener("click", (e) => {
        if (!e.target.closest(".dropdown")) {
            dropdown.style.display = "none";
        }
    });
}

function geocodeAddress() {
    const address = document.getElementById('address').value;
    if (!address) return alert("Please enter an address.");
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
        .then(res => res.json())
        .then(data => {
            if (!data.length) return alert("Address not found.");
            const lat = parseFloat(data[0].lat);
            const lng = parseFloat(data[0].lon);
            placeMarker(lat, lng);
        });
}

function updateMapFromLatLng() {
    const lat = parseFloat(document.getElementById('latitude').value);
    const lng = parseFloat(document.getElementById('longitude').value);
    if (!isNaN(lat) && !isNaN(lng)) {
        placeMarker(lat, lng);
    }
}

function placeMarker(lat, lng) {
    if (marker) {
        marker.setLatLng([lat, lng]);
    } else {
        marker = L.marker([lat, lng]).addTo(map);
    }
    map.setView([lat, lng], 15);
    document.getElementById('latitude').value = lat.toFixed(6);
    document.getElementById('longitude').value = lng.toFixed(6);
}

function initMap() {
    if (map) map.remove();
    map = L.map('map').setView([3.139, 101.6869], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    map.on('click', function (e) {
        placeMarker(e.latlng.lat, e.latlng.lng);
    });
}
</script>

<style>
.flowchart-box:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}
.flowchart-box.active {
    border: 2px solid #000;
}
.dropdown-content {
    display: none;
    position: absolute;
    background-color: white;
    border: 1px solid #ddd;
    max-height: 150px;
    overflow-y: auto;
    z-index: 1000;
}
.dropdown-content div {
    padding: 5px;
    cursor: pointer;
}
</style>

{% endblock %}